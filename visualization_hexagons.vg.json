{
  "$schema": "https://vega.github.io/schema/vega/v5.json",
  "width": 400,
  "height": 300,
  "background": "black",
  "signals": [
    {
      "name": "current_step",
      "value": 0,
      "bind": {"input": "range", "min": 0, "max": 1500, "step": 1}
    },
    {"name": "rows", "init": "y_extent[1]+1"},
    {"name": "columns", "init": "x_extent[1]+1"},
    {
      "name": "scale",
      "init": "round(100*max(1,width/height))/100",
      "bind": {"input": "range", "min": 0, "max": 2},
      "on": [
        {
          "events": "view:mousewheel",
          "update": "round(max(0, min(2, scale + (event.wheelDelta > 0 ? 0.1 : -0.1)))*100)/100"
        }
      ]
    },
    {"name": "hexalength", "update": "sin(PI)"},
    {"name": "sizeref", "init": "min(width,height)"},
    {"name": "sizeSymbol", "update": "bandwidth('hscale')"},
    {"name": "hcl_white", "init": "hcl('white')"},
    {
      "name": "visualization",
      "value": "umatrix",
      "bind": {"input": "select", "options": ["iso", "umatrix", "classes"]}
    },
    {"name": "showClasses", "update": "visualization === 'classes'"},
    {"name": "showIso", "update": "visualization === 'iso'"},
    {"name": "hivewidth", "update": "sizeSymbol*columns"}
  ],
  "data": [
    {
      "name": "neurons",
      "format": {
        "type": "dsv",
        "delimiter": ";",
        "parse": {
          "x": "number",
          "y": "number",
          "z": "number",
          "step": "number",
          "score": "number",
          "secondary": "number",
          "class": "number",
          "stabilized": "number",
          "score1": "number",
          "score2": "number"
        },
        "header": [
          "vector",
          "x",
          "y",
          "z",
          "step",
          "score",
          "class",
          "secondary",
          "stabilized",
          "score1",
          "score2",
          "entries"
        ]
      },
      "url": "https://raw.githubusercontent.com/mtiberghien/DNF1ED01-SOM/master/som2D_n.data?token=ASL2ZNPPNMRLJPHNVPYECPDALDK64",
      "transform": [
        {"type": "extent", "signal": "steps", "field": "step"},
        {"type": "filter", "expr": "datum.step === current_step"},
        {"type": "extent", "field": "y", "signal": "y_extent"},
        {"type": "extent", "field": "x", "signal": "x_extent"},
        {"type": "extent", "field": "score", "signal": "scores"},
        {
          "type": "formula",
          "expr": "split(replace(replace(datum.vector, '[',''),']',''),',')",
          "as": "vector"
        },
        {"type": "formula", "expr": "datum.x+'.'+datum.y", "as": "id"}
      ]
    },
    {
      "name": "umatrix",
      "source": "neurons",
      "transform": [
        {"type": "project", "fields": ["x", "y", "vector"]},
        {
          "type": "formula",
          "expr": "sequence(datum.x-1,datum.x+2,1)",
          "as": "nx"
        },
        {
          "type": "formula",
          "expr": "sequence(datum.y-1,datum.y+2,1)",
          "as": "ny"
        },
        {"type": "flatten", "fields": ["ny"]},
        {"type": "flatten", "fields": ["nx"]},
        {
          "type": "filter",
          "expr": "datum.nx >= 0 && datum.ny >=0 && datum.nx < columns && datum.ny < rows && (((datum.y%2 === 1 && datum.nx < (datum.x+1)) || (datum.y%2 === 0 && datum.nx > (datum.x-1))) || datum.ny === datum.y) && (datum.nx !== datum.x || datum.ny !== datum.y)"
        },
        {"type": "formula", "expr": "datum.nx+'.'+datum.ny", "as": "nid"},
        {
          "type": "lookup",
          "key": "id",
          "from": "neurons",
          "fields": ["nid"],
          "values": ["vector"],
          "as": ["nvector"]
        },
        {"type": "flatten", "fields": ["vector", "nvector"]},
        {
          "type": "formula",
          "expr": "pow(datum.vector - datum.nvector, 2)",
          "as": "d"
        },
        {
          "type": "aggregate",
          "fields": ["d"],
          "ops": ["sum"],
          "groupby": ["x", "y", "nx", "ny"],
          "as": ["d"]
        },
        {"type": "formula", "expr": "sqrt(datum.d)", "as": "d"},
        {
          "type": "aggregate",
          "fields": ["d"],
          "ops": ["mean"],
          "groupby": ["x", "y"],
          "as": ["d"]
        },
        {"type": "formula", "expr": "datum.x+'.'+datum.y", "as": "id"},
        {
          "type": "lookup",
          "from": "neurons",
          "key": "id",
          "fields": ["id"],
          "values": ["class", "secondary", "score", "score1", "score2"]
        }
      ]
    },
    {
      "name": "contours",
      "values": [
        {
          "width": 40,
          "height": 40,
          "values": [
            0.10416710921032983,
            0.17731070631974544,
            0.2597727392149945,
            0.25264910530089507,
            0.13876912133271047,
            0.12777000542390715,
            0.154893253937053,
            0.11968860894322977,
            0.15277640077880655,
            0.1617072578714465,
            0.12035290688130607,
            0.1284319091754273,
            0.12048073285241957,
            0.15705547171241843,
            0.15037997366628053,
            0.1111199854313724,
            0.12832268621776308,
            0.12543777039778964,
            0.1381664895229403,
            0.15095360245128767,
            0.13713249061910518,
            0.13417042221558112,
            0.12059801150224674,
            0.13754919894901896,
            0.14505943769428428,
            0.10395323399116692,
            0.10134457225272446,
            0.10058449178406605,
            0.11500176133738926,
            0.14052188084661835,
            0.1394825979213738,
            0.13357154523062753,
            0.13577863722097802,
            0.0841444049962018,
            0.07905424638427143,
            0.24461552271560294,
            0.3022256023522552,
            0.19431372610868763,
            0.11271998565943142,
            0.09053046779477447,
            0.12670138158056865,
            0.1583398617001128,
            0.22131682620811463,
            0.2471828024715319,
            0.19256361673281966,
            0.1390710158745327,
            0.16377096962680274,
            0.14641521664489043,
            0.14253706719170087,
            0.17151941713882976,
            0.14044779986032663,
            0.13643815789368416,
            0.1653997714456561,
            0.15960994185059735,
            0.19325610286172487,
            0.1673958945901474,
            0.14252810449392686,
            0.1432887229386557,
            0.12604972789912114,
            0.13862061531504755,
            0.14980953337862127,
            0.14512039096801377,
            0.15114163925746976,
            0.15252734051348416,
            0.1576733805414925,
            0.1374030464133136,
            0.12260834766211424,
            0.13923461579390722,
            0.1355392823351438,
            0.15505645137181992,
            0.16678868947220313,
            0.15473269588125702,
            0.13644921518140624,
            0.13034206176547997,
            0.10135586524565007,
            0.16476682350402683,
            0.30065249073457817,
            0.27000583091118013,
            0.18617904069104807,
            0.2106218795689236,
            0.21399200377425964,
            0.232203142537309,
            0.2712242676281644,
            0.2153259119007894,
            0.15568611265041823,
            0.16494365983984724,
            0.1596791143719865,
            0.15048076434524582,
            0.16508142301805212,
            0.1571096529461429,
            0.14988548556482273,
            0.19483282071373947,
            0.17381412063682294,
            0.16426293368243147,
            0.20439291659588196,
            0.1939970815777242,
            0.1647480235287055,
            0.13218319191883335,
            0.1260993537873661,
            0.14568363750737706,
            0.1425495013302201,
            0.14265468383960606,
            0.16752107712950695,
            0.1682708117661242,
            0.15348894324756174,
            0.14706851003628654,
            0.15840537015365413,
            0.16809374656090104,
            0.16351514523023433,
            0.18490048260948416,
            0.18504988775829884,
            0.14927997766901938,
            0.1490589207507656,
            0.1486077207075005,
            0.159292714764253,
            0.2520953465156525,
            0.3063404030192386,
            0.26406793426280206,
            0.22046393600271164,
            0.19361482939410038,
            0.21795066530486523,
            0.24389931820640454,
            0.2535144689250239,
            0.1934595724382512,
            0.14403425873646455,
            0.1445071154920475,
            0.15896259378647473,
            0.1533646881179894,
            0.16529528210365146,
            0.15831256006603384,
            0.14850008115636865,
            0.1526430196012182,
            0.16150926318408407,
            0.13695310998145355,
            0.15577821456369864,
            0.17918174258384365,
            0.1960179101714064,
            0.21641766249885483,
            0.17791724013465118,
            0.16121293955268395,
            0.1527441908190232,
            0.1383062622239613,
            0.13870114210149062,
            0.14956477866223206,
            0.15066391061242865,
            0.16065757540496922,
            0.1557398677605816,
            0.14821735413708662,
            0.14277659932372733,
            0.1412155487976793,
            0.13969669489992584,
            0.13904045435150095,
            0.14546232536238016,
            0.15719717757318047,
            0.1606655503767574,
            0.17885337752903324,
            0.23548105595077637,
            0.2481392569002446,
            0.18678448890067015,
            0.139920790762451,
            0.18538446539895911,
            0.1717916300094612,
            0.15311883898024176,
            0.13243143260097961,
            0.1590161980445975,
            0.14458074228989282,
            0.12529538106925966,
            0.16773862046713559,
            0.16232055523155775,
            0.13400758695153447,
            0.13858987950418727,
            0.15629159605493842,
            0.1637279421118183,
            0.18012806119869956,
            0.17899751778757797,
            0.18298779735767706,
            0.2318978985807025,
            0.23785040463051613,
            0.19727805873347395,
            0.1794751770063689,
            0.18140236484129357,
            0.15251668815484126,
            0.13230498734863033,
            0.12937130821444745,
            0.15350549323129872,
            0.1750515657705553,
            0.15694334037551744,
            0.13525443398907344,
            0.1226987096114795,
            0.10162367958499674,
            0.09816631543840566,
            0.13252833707150208,
            0.14663862086246032,
            0.16847237273062848,
            0.16190202912086982,
            0.1942332928159161,
            0.20613759898797357,
            0.19369760601923194,
            0.16741339782497833,
            0.14224342285766267,
            0.09725281398471253,
            0.11740153877217445,
            0.13521445926383183,
            0.1400471990151153,
            0.15591524460745082,
            0.18243297319925916,
            0.1425962514256916,
            0.14440675469405995,
            0.17027938223271588,
            0.14697939480111588,
            0.15009272451044403,
            0.1664133955519362,
            0.13729364518239293,
            0.1557343378507751,
            0.19251817203352317,
            0.14330055573985478,
            0.17144723068946088,
            0.20700631529287125,
            0.18810485118518214,
            0.17539510897253494,
            0.2247817815348187,
            0.2412501153062382,
            0.1882006301872603,
            0.17116507079177026,
            0.17959702672097316,
            0.19742011971906742,
            0.19524606047053344,
            0.1727075007813894,
            0.1569589816377999,
            0.14726189717321347,
            0.11534387629786275,
            0.11588962738745345,
            0.1492763016897212,
            0.17735145380547368,
            0.21515490903100742,
            0.20546624575613806,
            0.20582407546542647,
            0.2002537058664398,
            0.1891645897400442,
            0.17397996734355384,
            0.11291471568486194,
            0.12361441625569129,
            0.13562008331366218,
            0.16508051611537042,
            0.18127894794601773,
            0.1876675247551636,
            0.16450218049037113,
            0.16796314196568474,
            0.1717115037511365,
            0.1426821047796231,
            0.16011253397973466,
            0.13692528145295163,
            0.10655550247324921,
            0.1779881634059143,
            0.13362856932739262,
            0.11151720133882118,
            0.19440097171872867,
            0.2057214033503621,
            0.1518670021159263,
            0.12035802312686152,
            0.22862988406800636,
            0.2271217556638123,
            0.19798284231449514,
            0.19467100923123842,
            0.18095842433918485,
            0.18834219040514616,
            0.19036894580928707,
            0.16252504824423408,
            0.15992498555539533,
            0.15186025824255966,
            0.1283031545880788,
            0.1525373961676877,
            0.17176658042064114,
            0.19585153465447913,
            0.18488342307207245,
            0.17092621207862926,
            0.18283197123396439,
            0.18264837678414692,
            0.16293850918707473,
            0.13725117434507716,
            0.14439881916012356,
            0.15026789958729042,
            0.1498895539054072,
            0.1640641551692685,
            0.20035438772630798,
            0.17913599549779344,
            0.16283502765496116,
            0.15269961475723728,
            0.1706257390906819,
            0.15633309973622775,
            0.11659235806642786,
            0.1330057797692611,
            0.13124348030870273,
            0.1668042774857675,
            0.18331300629360983,
            0.12116668241973533,
            0.15066083199267394,
            0.196193806264496,
            0.19070397299656255,
            0.10257938394365038,
            0.12703949752337798,
            0.2014804941317227,
            0.1629117938206562,
            0.15325756700138476,
            0.1197988330203706,
            0.10925381746558455,
            0.1640648523021739,
            0.16489009173535676,
            0.13623729517929403,
            0.15502994452125182,
            0.16166124910980675,
            0.16988313440674402,
            0.17785925873225505,
            0.15158182536369735,
            0.1748623376393143,
            0.15483258075079784,
            0.15653388235679305,
            0.15789687364427984,
            0.15602159203258822,
            0.1767358309031642,
            0.18502663198541136,
            0.1828065646578424,
            0.18334366858743634,
            0.20896479429913728,
            0.1832820936144346,
            0.13905002207245704,
            0.13565056633462133,
            0.1627826135866685,
            0.1695475246053842,
            0.13604615930419559,
            0.12791582698755677,
            0.15625155819809694,
            0.16728231040771446,
            0.16219479656051522,
            0.13406221903259447,
            0.14383209803232094,
            0.16568840420616293,
            0.1868711678861492,
            0.19420906190085924,
            0.1689029955714948,
            0.20111844240674612,
            0.1929372219094141,
            0.1692902659035468,
            0.13706410842050487,
            0.10708246910916447,
            0.1243583891077034,
            0.16826331392581304,
            0.16901239330557802,
            0.17105089760832112,
            0.1854802639194693,
            0.18375264161253946,
            0.17920599303332171,
            0.14525341212887835,
            0.15159132178685658,
            0.15021572239128234,
            0.15886120866147344,
            0.17973608473202513,
            0.17757751297336313,
            0.18938773951606663,
            0.18445042763149916,
            0.12902527949136003,
            0.16539314493084542,
            0.20510194583747743,
            0.18635300780141845,
            0.1852464317813137,
            0.16860304019607286,
            0.1464358825885413,
            0.1548567031080913,
            0.1662387121232652,
            0.17741670411009813,
            0.17777387831938937,
            0.1689255739091331,
            0.16210382110701702,
            0.13670775498231713,
            0.11466697414698838,
            0.13242401753510863,
            0.1545448488302556,
            0.1763695540492567,
            0.19443707889219738,
            0.17929845196316352,
            0.1792905122431574,
            0.20538808844437975,
            0.20410888115596956,
            0.16340293047615664,
            0.15628791822553606,
            0.16255845724976908,
            0.15614631975674748,
            0.153022295177336,
            0.1642358777852223,
            0.1804697075122981,
            0.1624213180097169,
            0.14648531636470857,
            0.13423645172486204,
            0.13963303909696134,
            0.15025938317752793,
            0.13700996357133038,
            0.17735003311120673,
            0.20135675266755074,
            0.17287636173687818,
            0.14848734853257167,
            0.1416686930222303,
            0.17792210200719463,
            0.16176109347673887,
            0.1583663859373545,
            0.18240139333589878,
            0.18898666631540356,
            0.20337224624643507,
            0.19298109431816904,
            0.1887248652382802,
            0.1920715075463063,
            0.16382693075522076,
            0.15783072107786447,
            0.1485029119190988,
            0.14064862043262863,
            0.1601835602446822,
            0.16779076955653432,
            0.17289787608152513,
            0.1836010467456406,
            0.16060538027144805,
            0.13659798703436477,
            0.16847240012245757,
            0.2041290666873123,
            0.17019625406023792,
            0.17285012530417157,
            0.17629047048278038,
            0.17433734396464184,
            0.15429242983041594,
            0.13618266076529756,
            0.1468992563951173,
            0.13317304657624776,
            0.1101651968908304,
            0.1106204924299749,
            0.12088552850985858,
            0.13667675136542942,
            0.13890561846826918,
            0.17004657300743747,
            0.193405367208152,
            0.15316204450730098,
            0.10350779980545438,
            0.07969759745357656,
            0.12469815963916875,
            0.14571343138841633,
            0.1675757472946962,
            0.15127571738667675,
            0.1747198135754282,
            0.18088891480888425,
            0.20239767159203564,
            0.20261698130389555,
            0.18321232741144733,
            0.18981884124513834,
            0.15847988610452587,
            0.15273438850941934,
            0.16849828824567162,
            0.1581279870206841,
            0.18234931408569066,
            0.19425850609721101,
            0.16367720026109708,
            0.14910793151143362,
            0.13500302137080147,
            0.1185992775075793,
            0.12494257481023759,
            0.15056216267947004,
            0.15123671260603405,
            0.16943592895691853,
            0.19993269365157867,
            0.14516920992003116,
            0.1428360856469525,
            0.11643686567511877,
            0.1220989424344498,
            0.15184985036365783,
            0.1276908316095012,
            0.11673576134742261,
            0.12711471327419135,
            0.1325811636209462,
            0.13885890444993307,
            0.16235465940831084,
            0.19247791248525153,
            0.1687376176287686,
            0.13543401165022995,
            0.12895249225216213,
            0.1336707873552635,
            0.15635559892044776,
            0.16525205300195914,
            0.1711680555124537,
            0.16987688990073024,
            0.19014206018111937,
            0.20226074097263574,
            0.14830361249447724,
            0.16236465287907548,
            0.16567709746936707,
            0.15155221836654542,
            0.17908170757402553,
            0.17969364856338946,
            0.17048553423339055,
            0.1769161482096002,
            0.16054408605693066,
            0.13405282350654268,
            0.11525325918371758,
            0.11446249110765011,
            0.12797591503981035,
            0.1386098656809197,
            0.11999805858204746,
            0.13767075269050746,
            0.24835546346891468,
            0.21409950507350142,
            0.16145850885502505,
            0.11350138629468158,
            0.09010930894318865,
            0.13836649731638542,
            0.16935824263704635,
            0.16986318533785658,
            0.16915428011258016,
            0.16555780770232434,
            0.16784665874495489,
            0.15401687626923571,
            0.15053770716314527,
            0.15212770507093734,
            0.15073452108736235,
            0.14651199670598286,
            0.13128134121341037,
            0.11511873597809909,
            0.15186828672177036,
            0.19256896698964163,
            0.16100597097900465,
            0.14594478532946623,
            0.17155592315271578,
            0.2065486667046728,
            0.14703626709776954,
            0.11803188926870296,
            0.16303614795977295,
            0.14781080993890094,
            0.15651515912635633,
            0.17671165894036128,
            0.17872932957058116,
            0.16305454464509328,
            0.16188593600863466,
            0.1641296010148135,
            0.15561676136659053,
            0.1317689012893892,
            0.13695252610124636,
            0.16025322550198726,
            0.11792315277891133,
            0.12179914135276634,
            0.20602931347731804,
            0.281321299386199,
            0.17119136393943526,
            0.13780802144919968,
            0.11247525511118463,
            0.11559826777373486,
            0.14806197967534257,
            0.14541066667040875,
            0.16608642566827142,
            0.1641635564118607,
            0.15439749452137286,
            0.14643735962085708,
            0.12530759750449097,
            0.11726623088668492,
            0.14200119253485755,
            0.15262134366959149,
            0.14835371128689964,
            0.122063527738908,
            0.1905495943564959,
            0.1863533534379061,
            0.1387225034519584,
            0.14120464620010714,
            0.21333905717441787,
            0.18144933610518282,
            0.11716649194329556,
            0.14092975341672845,
            0.14050757930926688,
            0.14062921202277773,
            0.15056171537025245,
            0.1738443168373069,
            0.16033635713630665,
            0.12192719487993164,
            0.1375194491978329,
            0.18215335163207277,
            0.1470067482723066,
            0.11572742502570633,
            0.16597243775725795,
            0.11737418386029802,
            0.08452927617171144,
            0.16249551156548675,
            0.26723676783300165,
            0.16085756246794436,
            0.10592787131885234,
            0.12516656975932997,
            0.1423794258728489,
            0.15609180992352814,
            0.12812400514586503,
            0.11167384053812582,
            0.12835463318989723,
            0.12547891097861374,
            0.12320012537529973,
            0.13415711174711273,
            0.1253001960078132,
            0.1494345286543198,
            0.18725701127999195,
            0.17454340239064836,
            0.15672070600634735,
            0.11492498823268452,
            0.14605045299333236,
            0.2075333294588995,
            0.16759645380052854,
            0.14262198611469243,
            0.18814422016652105,
            0.24214229160093628,
            0.13280647338929308,
            0.12325290919014924,
            0.14716124640975464,
            0.12222597309781415,
            0.146689247235879,
            0.15644321207450493,
            0.1641826012481144,
            0.1339354430837193,
            0.10534514693772203,
            0.1405730315277843,
            0.16189352218355246,
            0.11824437148539776,
            0.14626233979213016,
            0.1823675357701646,
            0.11089717427220105,
            0.12392691011461249,
            0.22341569913579698,
            0.25166470591668566,
            0.12303466647863354,
            0.12101085533972994,
            0.15545498798575416,
            0.1477170737710622,
            0.16718505332804312,
            0.1538989846766174,
            0.14684290855203294,
            0.14578729869005613,
            0.13792390946889746,
            0.13212820324004987,
            0.13226905824703586,
            0.1464601681488955,
            0.18835962206418022,
            0.18404056381101305,
            0.1472835085187406,
            0.16384111507497934,
            0.18469323307236904,
            0.17361027551651037,
            0.15808615557494224,
            0.17489380050673192,
            0.25800607918823476,
            0.18523924022053506,
            0.12094809247109609,
            0.13405461412607336,
            0.11763012163328931,
            0.1355915422914058,
            0.16817682763598485,
            0.15554996976011623,
            0.13681460140048873,
            0.13225174191511968,
            0.14557863510360677,
            0.16354647509571674,
            0.1289999923847821,
            0.1308366938326601,
            0.1913170503155167,
            0.1859388166721789,
            0.1407507632749174,
            0.1883616713182128,
            0.26379601260310553,
            0.18521589611804445,
            0.12974224998908507,
            0.15834555492880312,
            0.13787262477449985,
            0.13968934655090257,
            0.18164015509487247,
            0.1856205342815156,
            0.17280424509122105,
            0.1628819057135943,
            0.12789634019918017,
            0.11921966186278828,
            0.14648327674630934,
            0.1901215437864008,
            0.17649298030014185,
            0.11242834600890622,
            0.08662682372092566,
            0.13438950924055848,
            0.15747500951619037,
            0.17061150475946468,
            0.1506698359782941,
            0.16446606350025994,
            0.22801426012647194,
            0.2537033089699063,
            0.14315070558255738,
            0.11074851032602993,
            0.12513346118478683,
            0.12182303543735595,
            0.15953422412095533,
            0.16540437834707689,
            0.10091321371381598,
            0.0999532946589773,
            0.14061908824435296,
            0.14430340575297426,
            0.13088751048413128,
            0.12145689928214264,
            0.1401336301868517,
            0.17799454690404617,
            0.16034595956593323,
            0.1626239301873335,
            0.2277482378489496,
            0.21076806630384215,
            0.13064273962499967,
            0.13685528806507788,
            0.15789131812323526,
            0.14583850347605867,
            0.16552351303375498,
            0.16943250144992275,
            0.14561544644843552,
            0.15413856328822995,
            0.1325696915390196,
            0.1050371359172011,
            0.12573406869577233,
            0.17459092289772257,
            0.18426170834219724,
            0.1273019086925606,
            0.10301635442474474,
            0.12587328329462646,
            0.15453480005596326,
            0.16693194379573204,
            0.1474927629155774,
            0.16749908899463228,
            0.2433335693965733,
            0.1839939737526913,
            0.11959656966142174,
            0.13186314238062638,
            0.13287883075642873,
            0.13241650412292938,
            0.16407955565397486,
            0.12759570598915831,
            0.09689138381565596,
            0.12141471151510436,
            0.13499498198430707,
            0.12995218314718268,
            0.13485223753235615,
            0.13740729474363397,
            0.1447111060653512,
            0.14721462489021928,
            0.14507653163589002,
            0.2057214154048599,
            0.2129681016201334,
            0.14469180194150336,
            0.12798195344972174,
            0.1356791911230585,
            0.1403990857753932,
            0.15063176146525936,
            0.15055966964119777,
            0.13261915966708174,
            0.11870368428223636,
            0.1235011364317967,
            0.11209751689209144,
            0.09668053581823616,
            0.1371294549047964,
            0.18260049125819564,
            0.16459427450647976,
            0.14500690733344357,
            0.13449112334453917,
            0.12373942814153152,
            0.1365513671787543,
            0.15513983361394137,
            0.16427755098182423,
            0.15401427857381172,
            0.19472041403432155,
            0.2401157686308538,
            0.16108955773111056,
            0.12669026427627283,
            0.14404365553381276,
            0.12670688250605674,
            0.1254479169440371,
            0.15448030804800097,
            0.1317613608077675,
            0.11968399299727464,
            0.12488001217930236,
            0.13728187098159195,
            0.12996762279601196,
            0.12813748191314256,
            0.13352511080242147,
            0.13444664141698107,
            0.14176976103950195,
            0.15266365610592642,
            0.19484702633075857,
            0.16452575726712798,
            0.12169560146351097,
            0.13357564018946433,
            0.121085867636293,
            0.13280228894399707,
            0.1446902503316484,
            0.1571650238270176,
            0.1463593030176088,
            0.11253021037542661,
            0.1333446522486859,
            0.13919916429965357,
            0.1498545232776474,
            0.19293389318259677,
            0.18550975529121455,
            0.16506058882345553,
            0.15113954049810882,
            0.14575768411050763,
            0.14467994557346234,
            0.1716363785521185,
            0.15564645647076214,
            0.13977088003143204,
            0.2044400156601644,
            0.2080046239823765,
            0.15464886605848333,
            0.12607968438250874,
            0.13069976758471996,
            0.141392175216212,
            0.1585424881717768,
            0.16371669640593625,
            0.13850553340587307,
            0.13436683764235474,
            0.14917271196367327,
            0.1449456378480332,
            0.12414676468944992,
            0.1303296390527971,
            0.13513482611696706,
            0.1541624946668646,
            0.16542942226410368,
            0.18478610387355532,
            0.18967343820494093,
            0.15774763728429586,
            0.14359645868077692,
            0.1275453040304495,
            0.12861925604636001,
            0.15003219669123585,
            0.1465993928392565,
            0.18169356221634103,
            0.14321725634896243,
            0.13135625713310195,
            0.14084627619606702,
            0.12621850970804407,
            0.19643307418786118,
            0.17292642487715848,
            0.14554116503555575,
            0.12356871087111068,
            0.1094105429911846,
            0.10856382141460261,
            0.1271940340958508,
            0.15900222115960605,
            0.15651691868667095,
            0.12497001358870813,
            0.14617662281639593,
            0.19724507194082658,
            0.17625216057030674,
            0.1575959638973204,
            0.1471215567417285,
            0.13662426222751448,
            0.13878553641378316,
            0.15574606649857695,
            0.15750321873699127,
            0.1510741451532237,
            0.1368764009044352,
            0.12345283661825801,
            0.12963816099359846,
            0.13105598455263323,
            0.14375085150584743,
            0.15138280453707004,
            0.19024818135079644,
            0.181244470953306,
            0.1434414733928342,
            0.1481719665476139,
            0.13624298384945335,
            0.12789091000525998,
            0.12353147725113034,
            0.15254964808431903,
            0.1672678648469347,
            0.16021225910172712,
            0.17477011216578203,
            0.131115558728005,
            0.1249802053776119,
            0.09918743529591666,
            0.11500981025067085,
            0.19969216634033576,
            0.13843205555978508,
            0.11930833609143567,
            0.12508137517694473,
            0.11445460415489557,
            0.1514177674116885,
            0.17525629221794128,
            0.1633852395595928,
            0.1559044402418207,
            0.18697997205004313,
            0.15612098153255852,
            0.16041127601134475,
            0.1733914469411501,
            0.14038013247872577,
            0.10807548194561845,
            0.1161210588452633,
            0.17231025580188697,
            0.17754427565491626,
            0.13928231076230854,
            0.11252727939465126,
            0.10718746944552503,
            0.11613877375064606,
            0.12439542628780056,
            0.13955058867220066,
            0.18068264549626198,
            0.1756702698035169,
            0.11173990885788114,
            0.10383607358417433,
            0.10241771381117529,
            0.10206385220807729,
            0.11583643610801433,
            0.12441203847354063,
            0.14541432090858128,
            0.17265866786659462,
            0.19747892855343427,
            0.14848365169954125,
            0.1335115703442267,
            0.1435847344429385,
            0.11880880607487151,
            0.18178087762886655,
            0.19820126853960907,
            0.1572771934766902,
            0.13532941318024444,
            0.11876497860606999,
            0.10133280906127166,
            0.12393516212457664,
            0.16053491900316302,
            0.15342513319103113,
            0.15219140014886584,
            0.1518487865990304,
            0.16124180377403197,
            0.15639998145751258,
            0.1784586170333245,
            0.18248969128841142,
            0.1628810694424787,
            0.15267100465009226,
            0.18306691149731613,
            0.19874664026011407,
            0.17537195657459492,
            0.16705092939695676,
            0.181232003262902,
            0.18284163960356303,
            0.1576137756055489,
            0.15042972100798807,
            0.15527438112773434,
            0.1751472203927673,
            0.14357967969134405,
            0.10852523725384189,
            0.10053996827203615,
            0.08148709184848035,
            0.09465394029260116,
            0.10516229007326257,
            0.08485569807805951,
            0.12139992332564485,
            0.1861503651419595,
            0.2065983171967467,
            0.12349132769015388,
            0.1386500473703027,
            0.14230554446082053,
            0.1482978764457328,
            0.19525899791343457,
            0.20277546659867576,
            0.15227852990197774,
            0.1171134528269133,
            0.13429926063707912,
            0.13919332845323384,
            0.1477225570446155,
            0.13167452704390165,
            0.110214244916992,
            0.12126356960161261,
            0.175675403501158,
            0.18402167579217338,
            0.16713904417310835,
            0.1638593344873016,
            0.1827018094587717,
            0.1944399518617087,
            0.19530147592091768,
            0.18483384866228944,
            0.19260430929874844,
            0.20345857799807185,
            0.21078812275594072,
            0.1987902426116909,
            0.17318971947155792,
            0.15760826139146605,
            0.1632262903888095,
            0.14950902640209787,
            0.11413549657651044,
            0.10147713228776942,
            0.09473096060079216,
            0.10679533224330696,
            0.13377452087093686,
            0.12090450527168319,
            0.1253607048311806,
            0.16049601774748604,
            0.22159865690840144,
            0.1687763855512023,
            0.1325093350283068,
            0.12496072022505567,
            0.12339711026720876,
            0.15310233584679284,
            0.1908514968037938,
            0.17462290303721012,
            0.13392819903768635,
            0.1158677980623997,
            0.11784303654197295,
            0.13259605072750702,
            0.1686843813630235,
            0.1711514268188537,
            0.12462963089799824,
            0.10219826977016314,
            0.1376262636527581,
            0.1743119264510116,
            0.14375684255506307,
            0.10661495872512954,
            0.12853354792785698,
            0.14755963195959892,
            0.1611435471437651,
            0.16204494275630882,
            0.15379096211999285,
            0.15184267242044538,
            0.1468267839534314,
            0.1512852311253042,
            0.14837537136313322,
            0.15266652843821885,
            0.14820316847043755,
            0.14008761807161196,
            0.12290574264922793,
            0.12701123605712408,
            0.15218519126152924,
            0.1554732579826503,
            0.17192380999773216,
            0.17732823038810716,
            0.16589012309259243,
            0.1434664365411435,
            0.15619625168298404,
            0.18330494598292438,
            0.15124160864339986,
            0.14407815776296276,
            0.1219200108214736,
            0.1394656871844978,
            0.17111658129440319,
            0.18805027393576934,
            0.17640431848638422,
            0.15169662760919825,
            0.11607950172994083,
            0.1626393155164089,
            0.16531485978499316,
            0.13510216862905947,
            0.134998349996258,
            0.13002078968698375,
            0.16412956346031543,
            0.1602854094779543,
            0.11874367583688566,
            0.11345787216105879,
            0.13679528413750625,
            0.15596149945179416,
            0.15242292385006084,
            0.1216359536636445,
            0.11390615846804938,
            0.115260649109307,
            0.11789800862033535,
            0.11244204496525599,
            0.12299815237038117,
            0.12884428920765348,
            0.12503368022233965,
            0.11628794991587593,
            0.14589998547050922,
            0.17788684994462395,
            0.1611587515469186,
            0.1648466843751935,
            0.1551754837875841,
            0.1658016160004763,
            0.12815919797892453,
            0.10301000842029415,
            0.11951092379415958,
            0.12515721849806838,
            0.1641971747692605,
            0.1412443013865831,
            0.1278140872340579,
            0.161067860351117,
            0.18532886861975115,
            0.20213799468050164,
            0.15107348666477782,
            0.12503888766431773,
            0.11589413131607619,
            0.141624449594659,
            0.16320918283076188,
            0.10618481594397008,
            0.12583711093457695,
            0.15123059115025492,
            0.15500494235623605,
            0.16861514145072815,
            0.14353025614375642,
            0.13061927613109273,
            0.13899672182278766,
            0.15771647749027307,
            0.1686197716092069,
            0.13142311569545104,
            0.11129932782352221,
            0.10851290226113439,
            0.10149426636702563,
            0.09444571748318953,
            0.09835752174088615,
            0.11949997784674228,
            0.13232106040712177,
            0.12082339440772485,
            0.13144840520661147,
            0.16811000136226958,
            0.12446389864372,
            0.10984210718205609,
            0.1407834138504577,
            0.13765544965182905,
            0.16073605015120596,
            0.13136127740852016,
            0.11371751326543499,
            0.1108965330048033,
            0.1372563902005107,
            0.17575896949666264,
            0.1402933740403538,
            0.14886322825243634,
            0.13884500970413935,
            0.16345661201380862,
            0.18722608957144918,
            0.14775801424732724,
            0.1513809802635968,
            0.1662416148657568,
            0.17954776326640307,
            0.1968160048694542,
            0.18939045998528295,
            0.18239660729586082,
            0.18993670206242422,
            0.15457058326478393,
            0.12990606848336628,
            0.13322054814812,
            0.14499306591613625,
            0.15978451719240916,
            0.12881380054391992,
            0.1199055468794145,
            0.10411091683172174,
            0.09555040293221624,
            0.1013754828135912,
            0.11437658521538704,
            0.11959403204672989,
            0.12375757851601303,
            0.13350158158974074,
            0.11390336760610871,
            0.1487145512133689,
            0.15516375263710502,
            0.10592972302845827,
            0.11647082606439545,
            0.13860982792797535,
            0.15551305878907454,
            0.14588949483105848,
            0.14002190716957066,
            0.1331279506011798,
            0.1297282940222671,
            0.16636830313626513,
            0.18067688103448767,
            0.17015091989257702,
            0.13469526064616638,
            0.1175822759953059,
            0.18969657095961664,
            0.19024241604825712,
            0.1628417272429414,
            0.1394191000214706,
            0.14988758028333093,
            0.18365309218165754,
            0.21667663243422602,
            0.20761420555866245,
            0.1936155286764194,
            0.22577991212084916,
            0.20007885589414634,
            0.1707365324783443,
            0.16954992142393324,
            0.17667958382683985,
            0.16833254965905928,
            0.1421950030488994,
            0.12882795523675786,
            0.12520553044062055,
            0.11550005232134786,
            0.12628439934291324,
            0.13491797569189723,
            0.14260568907680754,
            0.11593253362551244,
            0.1255924544054816,
            0.1388441741022916,
            0.12069939752017367,
            0.15839975338063664,
            0.16098756602813874,
            0.12925413859163348,
            0.13627193596932335,
            0.14824046348048134,
            0.13788402760602264,
            0.11931131050182822,
            0.13946438206281347,
            0.14852214050808837,
            0.15320262759739073,
            0.17229573691655248,
            0.18522566749104385,
            0.19324347638105266,
            0.16407075846583818,
            0.17994363651099227,
            0.19126201187573125,
            0.1414115329751452,
            0.11660853684081245,
            0.1645869268378272,
            0.15808363166811043,
            0.12795399081577136,
            0.13963934640526574,
            0.24012650683975087,
            0.21381317447881182,
            0.1810969485102622,
            0.20413763968567902,
            0.21118817913429458,
            0.18675589210745203,
            0.1550602563627028,
            0.15272827536415012,
            0.16124415123383642,
            0.15921983508364157,
            0.1582013689167006,
            0.14644948951813963,
            0.15863235449760688,
            0.1400488397415989,
            0.11935460454481792,
            0.13707847635158152,
            0.11935327437563065,
            0.11775479209462789,
            0.1531331505098542,
            0.15977573287304345,
            0.15150814266208856,
            0.15739985649333046,
            0.16124486177364444,
            0.1482820068026527,
            0.14427067973366048,
            0.1291176158893329,
            0.14636230787507065,
            0.15430533643099342,
            0.14540151790069764,
            0.17625116508522043,
            0.1745006295191504,
            0.15504109506361155,
            0.20914229714682755,
            0.15064285784621273,
            0.11550919157116159,
            0.07667338150931242,
            0.10430864528314376,
            0.16945404174365405,
            0.11813959962033685,
            0.10628833866506614,
            0.17404516917218008,
            0.24089928165839805,
            0.11816947107388133,
            0.14331890140145637,
            0.20709832801253075,
            0.16152806576463336,
            0.16044169546591758,
            0.1605194482140218,
            0.16996448431277542,
            0.17632984748687305,
            0.16212490435953217,
            0.14979547850427535,
            0.15370245282403286,
            0.1545456220606964,
            0.12258312602270305,
            0.10638322710782921,
            0.11086464307593705,
            0.11060321070208438,
            0.12524007824684993,
            0.1403221712372497,
            0.12297399130763595,
            0.1306951290753529,
            0.15142028041761998,
            0.14537650770268232,
            0.13803687592361977,
            0.11929778153655247,
            0.11275510575911554,
            0.14856268376999604,
            0.15658140411745286,
            0.15282889481150116,
            0.16965620835219883,
            0.1351265802335137,
            0.1774867568372253,
            0.22667504044720413,
            0.16556775267762575,
            0.17813434448794005,
            0.18434292450401457,
            0.16306387193671074,
            0.14827476834149927,
            0.1699195298603502,
            0.23772992240452362,
            0.1578375143501046,
            0.11006564084952455,
            0.18236611977938266,
            0.1448393229327053,
            0.12270729932872328,
            0.15729662785306514,
            0.15942607408774429,
            0.15258199974342979,
            0.1322939298843982,
            0.12961880999885328,
            0.14060381118167384,
            0.14552850856299288,
            0.12465878327103595,
            0.1049002930815546,
            0.10755189779120754,
            0.12261776954011083,
            0.15029791900358275,
            0.1742776556097957,
            0.15173480908214496,
            0.13321480566169083,
            0.14874292570230016,
            0.13365321971976515,
            0.12013289450189044,
            0.12820948020569706,
            0.12292383958893888,
            0.1353842058247199,
            0.1666182919916337,
            0.16623298858462157,
            0.18451710864436296,
            0.1937406704480343,
            0.18844649761224297,
            0.2367223802854267,
            0.18815450660468158,
            0.14775904632856682,
            0.1600152947185828,
            0.17895592705119162,
            0.18815430937750807,
            0.17773437548908722,
            0.19417991620003394,
            0.19579950627450227,
            0.19746817353741802,
            0.16472338842793607,
            0.17160837843496607,
            0.18524320969049063,
            0.1504091708570631,
            0.16053635974783076,
            0.17591629626815053,
            0.1513907304063832,
            0.12843633333144439,
            0.11763325280455472,
            0.1381384598902246,
            0.14443149274810688,
            0.12413711536783056,
            0.11896388617799963,
            0.1163580087547706,
            0.1120351750344963,
            0.12548508836310573,
            0.17059996197447047,
            0.16360691905607702,
            0.15555776773397595,
            0.15935316186171422,
            0.16521229549141825,
            0.14549706431820758,
            0.13273974058776117,
            0.1345287522690352,
            0.12052119570138846,
            0.13120674941924715,
            0.16998331795850402,
            0.18732734032977819,
            0.20177688740000677,
            0.19547781166399905,
            0.19735829554678735,
            0.20539119989824253,
            0.17390286225255489,
            0.10705654509718412,
            0.1632619426971978,
            0.1843491763969592,
            0.17229197998810633,
            0.1736900715600126,
            0.1855025318168606,
            0.19551772247797672,
            0.17546494345762495,
            0.16215291060201348,
            0.1877407733697648,
            0.20038358506750303,
            0.19979082173888923,
            0.17624212172075135,
            0.15406664177214704,
            0.12744998550295097,
            0.13343341305666478,
            0.16514663670464258,
            0.1339995284612827,
            0.12337805680408989,
            0.14322190746339697,
            0.13848946503898335,
            0.12448709779179995,
            0.15093442931132198,
            0.13998960014310977,
            0.12555910162561135,
            0.1273750895507546,
            0.14912228000036593,
            0.17040623296676116,
            0.14764897934732388,
            0.13452142259595343,
            0.136342185894448,
            0.11748045028759777,
            0.131256013481244,
            0.17963972010795334,
            0.18036277124742087,
            0.16784380367390667,
            0.15810350824631547,
            0.17448867036370988,
            0.1577357783993486,
            0.1410693902723096,
            0.11231839792925115,
            0.1318474977947212,
            0.16406072429173163,
            0.14998368864758432,
            0.15839036908833634,
            0.1919501230492409,
            0.21225256861794922,
            0.17421905918550917,
            0.14127558430918943,
            0.16963568777845472,
            0.1928908917679777,
            0.18497150899281672,
            0.19477556837289522,
            0.19716802568900094,
            0.16165547042385636,
            0.14268736242963706,
            0.16577758216986252,
            0.17714158018366494,
            0.13223978337100772,
            0.12564216082613314,
            0.15421360574159457,
            0.16911219308765976,
            0.1729274299186342,
            0.165483297180757,
            0.12218646355777676,
            0.10111226318993119,
            0.1118833708141631,
            0.15193163088126246,
            0.15053789405757964,
            0.1428530802933311,
            0.17286765333344767,
            0.17075487129156516,
            0.1264279112044875,
            0.14078641229694822,
            0.16293879812989054,
            0.1733713011851925,
            0.1924475770763001,
            0.1877902930578558,
            0.16346831551747687,
            0.14150432924306103,
            0.12066049944378629,
            0.14147660617720348,
            0.16141464938676464,
            0.1788629382825014,
            0.20387199119598454,
            0.22612698031571082,
            0.19802629078640724,
            0.1450216313281769,
            0.15737464393388115,
            0.17838326805796237,
            0.13364718304414597,
            0.13286088672998944,
            0.1676304207955465,
            0.19995925327468297,
            0.19396242783171774,
            0.17986111771571056,
            0.18524507289722,
            0.17802293794180857,
            0.1472260863058871,
            0.14568462216902348,
            0.1518048512793743,
            0.15152201527311304,
            0.1609369154876799,
            0.1510550729896676,
            0.13464484208305547,
            0.12910626377629897,
            0.15323881300461298,
            0.14290204579028892,
            0.1409586423779406,
            0.1660782881690075,
            0.17447085769267776,
            0.16089621193283762,
            0.1624619112259204,
            0.17058885266830504,
            0.17214848128418495,
            0.19495758464343754,
            0.19485385615360545,
            0.18432768651878337,
            0.1481478430750746,
            0.13475326069623716,
            0.125313496484832,
            0.14728152461991023,
            0.19231315626778372,
            0.1864304618407817,
            0.1915814696317498,
            0.20842366213677144,
            0.2245571139071014,
            0.1849015786507377,
            0.13874407147992152,
            0.16902192262439708,
            0.1697671448589483,
            0.13139458831583278,
            0.13125980249693917,
            0.15206196180062267,
            0.19812933653261441,
            0.2174819803795339,
            0.17406169708670965,
            0.16511914773027242,
            0.17321785469566714,
            0.15724601592855691,
            0.145072885068631,
            0.1361569218632314,
            0.14215639568020064,
            0.1592046255583716,
            0.16002466454420544,
            0.17203969629648985,
            0.17341258618012564,
            0.16700655739999498,
            0.15920222486951716,
            0.16787192594116165,
            0.15526605935741808,
            0.14349952800833585,
            0.16622875225363243,
            0.1910022734885704,
            0.1894894284977709,
            0.175028469388276,
            0.16229568914194342,
            0.17341044838180902,
            0.18195840510187147,
            0.1674292349281328,
            0.13481011798911152,
            0.19184878422900017,
            0.1709861939971649,
            0.14768471556708226,
            0.14328767751601357,
            0.19870364014531067,
            0.2191258744466621,
            0.1391492801666851,
            0.11321184111838205,
            0.15950011668124253,
            0.1720684485210955,
            0.14847608792542877,
            0.13553536094454882,
            0.1338541350297182,
            0.17809890058775568,
            0.19790818947304079,
            0.15700499529891482,
            0.1509769847015274,
            0.13661701220110845,
            0.139455658721565,
            0.12750857806852764,
            0.13413425632504483,
            0.1650952052195762,
            0.13547588650889314,
            0.136906946988078,
            0.14605206973714302,
            0.13622503620415638,
            0.13442801706383747,
            0.13758117392800603,
            0.15860696733165258,
            0.131620094081954,
            0.1426677726439117,
            0.1518742120357672,
            0.15700285449801166,
            0.1608109987722972,
            0.13497926850062716,
            0.14834826790329156,
            0.1721644170789547,
            0.1390800477875758,
            0.11249230601232231,
            0.07924594560750974,
            0.13400791535136142,
            0.18879687074949436,
            0.12762451785720696,
            0.12225238681404496,
            0.147474313626354,
            0.2152959970079973,
            0.17881469013444426,
            0.09917563252596567,
            0.11132877425993808,
            0.16261284168449325,
            0.15218899927328336,
            0.11682236790049058,
            0.10535108413900025,
            0.11333917000411133,
            0.18431450732415405,
            0.18362966368666303,
            0.14031976584172873,
            0.130025706420311,
            0.11464567967773709,
            0.11236128800986706,
            0.11370922100366224,
            0.15146443938055562,
            0.13859133183363592,
            0.08940572472535918,
            0.11716788192270924,
            0.11454130094625756,
            0.10156119125372894,
            0.09630447131853287,
            0.1233554292341696,
            0.13980982678606177,
            0.12793862013121032,
            0.14371076057364204,
            0.13450924040566328,
            0.13266482503656016,
            0.13322958924349487,
            0.12169466982523125,
            0.14916950301858964,
            0.12308538001067701,
            0.07062482510947811
          ]
        }
      ],
      "transform": [
        {"type": "formula", "expr": "columns", "as": "width"},
        {"type": "formula", "expr": "rows", "as": "height"},
        {
          "type": "formula",
          "expr": "pluck(data('umatrix'),'d')",
          "as": "values"
        },
        {
          "type": "isocontour",
          "scale": {"expr": "hivewidth/datum.width"},
          "translate": [
            {"signal": "(width - hivewidth)/2"},
            {"signal": "(height - (hivewidth*rows/columns))/2"}
          ]
        }
      ]
    }
  ],
  "legends": [
    {
      "title": "Classes",
      "orient": "right",
      "fill": "color",
      "labelColor": "#eee",
      "titleColor": "#eee",
      "encode": {
        "labels": {"update": {"opacity": {"signal": "showClasses ? 1 :0"}}},
        "symbols": {"update": {"opacity": {"signal": "showClasses ? 1 :0"}}},
        "title": {"update": {"opacity": {"signal": "showClasses ? 1 :0"}}}
      }
    }
  ],
  "scales": [
    {
      "name": "hscale",
      "type": "band",
      "domain": {"signal": "sequence(0,max(rows,columns)+1,1)"},
      "range": [0, {"signal": "sizeref*scale"}]
    },
    {
      "name": "g-color",
      "domain": {"data": "umatrix", "field": "d"},
      "range": {"scheme": "greys"}
    },
    {
      "name": "color",
      "type": "ordinal",
      "domainMin": 0,
      "domain": {"data": "umatrix", "field": "class", "sort": true},
      "range": {"scheme": "category20"}
    },
    {
      "name": "iso-color",
      "type": "linear",
      "domain": {"data": "umatrix", "field": "d"},
      "range": {"scheme": "blueorange"}
    }
  ],
  "marks": [
    {
      "type": "path",
      "from": {"data": "contours"},
      "encode": {
        "enter": {
          "stroke": {"value": "#ccc"},
          "strokeWidth": {"value": 1},
          "fill": {"scale": "iso-color", "field": "contour.value"}
        },
        "update": {"opacity": {"signal": "showIso ? 1 :0"}}
      },
      "transform": [{"type": "geopath", "field": "datum.contour"}]
    },
    {
      "type": "symbol",
      "from": {"data": "umatrix"},
      "encode": {
        "enter": {
          "shape": {"value": "m0,-1 l1,.5 v1 l-1,.5 l-1,-.5 v-1 l1,-.5"},
          "stroke": {"value": "#777"}
        },
        "update": {
          "size": {"signal": "pow(sizeSymbol,2)"},
          "opacity": {"signal": "showIso ? 0.2 : 1"},
          "xc": {
            "field": "x",
            "scale": "hscale",
            "offset": {
              "signal": "(datum.y%2==1 ? 0 : sizeSymbol/2) + (width - sizeSymbol*columns)/2 + sizeSymbol/4"
            }
          },
          "fill": [
            {
              "test": "showClasses && datum.class >-1",
              "signal": "datum.secondary > -1 ? datum.secondary : datum.class",
              "scale": "color"
            },
            {"test": "showClasses && datum.class == -1", "value": "#555"},
            {"field": "d", "scale": "g-color"}
          ],
          "yc": {
            "field": "y",
            "scale": "hscale",
            "offset": {
              "signal": "(datum.y > 0 ? -datum.y*sizeSymbol/4 : 0) +(height - (sizeSymbol*rows - (rows-1)*sizeSymbol/4))/2 + sizeSymbol/2"
            }
          }
        }
      }
    },
    {
      "type": "symbol",
      "from": {"data": "umatrix"},
      "encode": {
        "enter": {
          "shape": {"value": "m0,-1 l1,.5 v1 l-1,.5 l-1,-.5 v-1 l1,-.5"}
        },
        "update": {
          "opacity": {"signal": "showIso || !showClasses ? 0 :1"},
          "tooltip": [
            {
              "test": "showClasses",
              "signal": "{'class':datum.class,'score':datum.score,'score max':datum.score1, 'score 2':datum.score2,'coords':[datum.x,datum.y]}"
            }
          ],
          "size": {
            "signal": "pow(0.95*sizeSymbol * (datum.score1/(datum.score || 1)||1),2)"
          },
          "xc": {
            "field": "x",
            "scale": "hscale",
            "offset": {
              "signal": "(datum.y%2==1 ? 0 : sizeSymbol/2) + (width - sizeSymbol*columns)/2 + sizeSymbol/4"
            }
          },
          "fill": [
            {
              "test": "showClasses == datum.class > -1",
              "field": "class",
              "scale": "color"
            },
            {"value": "#555"}
          ],
          "yc": {
            "field": "y",
            "scale": "hscale",
            "offset": {
              "signal": "(datum.y > 0 ? -datum.y*sizeSymbol/4 : 0) +(height - (sizeSymbol*rows - (rows-1)*sizeSymbol/4))/2 + sizeSymbol/2"
            }
          }
        }
      }
    }
  ]
}