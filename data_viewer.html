<!DOCTYPE html>
<html>
<head>
  <!-- Import Vega & Vega-Lite (does not have to be from CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
  <!-- Import vega-embed -->
  <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
</head>
<style>
.vega-bind-name{
  color:#fff;
}
</style>
<body style="background-color:black">
<div id="container" style="text-align:center">
<div id="vis" style="display:inline-block"></div>
</div>


<script type="text/javascript">
  var spec = {
  "$schema": "https://vega.github.io/schema/vega/v5.json",
  "width": 800,
  "height": 600,
  "background": "black",
  "signals": [
    {
      "name": "current_step",
      "value": -1,
      "bind": {"input": "range", "min": -1, "max": 749, "step": 1}
    },
    {"name": "showgrid", "value": false, "bind": {"input": "checkbox"}},
    {"name": "showrealdata", "value": false, "bind": {"input": "checkbox"}},
    {"name": "showneurons", "value": true, "bind": {"input": "checkbox"}},
    {"name": "showlinks", "value": true, "bind": {"input": "checkbox"}}
  ],
  "data": [
    {
      "name": "labels",
      "values": [
        {"id": 0, "name": "None"},
        {"id": 1, "name": "Iris-setosa"},
        {"id": 2, "name": "Iris-versicolor"},
        {"id": 3, "name": "Iris-virginica"}
      ]
    },
    {
      "name":"iris",
      "transform": [
        {
          "type":"filter",
          "expr":"isValid(datum.pw)"
        },
        {
          "type": "formula",
          "expr":"scale('id', datum.class)",
          "as":"class"
        }
      ],
      "format":{"type":"csv", "parse":{"sl":"number","sw":"number", "pl":"number", "pw":"number"}, "header": ["sl","sw","pl","pw","class"]},
      "url":"https://raw.githubusercontent.com/mtiberghien/DNF1ED01-SOM/master/iris.data?token=ASL2ZNJMDB3DV54GHZGUJ63AJIKOM"

    },
    {
      "name":"predictions",
      "url":"https://raw.githubusercontent.com/mtiberghien/DNF1ED01-SOM/master/predictions.data?token=ASL2ZNMX2DNC26JDOYJTMRDAJIPZW",
      "format":{"type":"dsv", "delimiter":";", "header": ["neuron","class"], "parse":{"neuron":"number", "class":"number"}}
      
    },
    {
      "name":"neurons",
      "format":{"type":"dsv", "delimiter":";", "parse":{"neuron":"number", "step":"number", "score":"number"}, "header": ["vector","neuron","step","score"]},
      "url":"https://raw.githubusercontent.com/mtiberghien/DNF1ED01-SOM/master/som.data?token=ASL2ZNJEDM7E7CPBR57EAMLAJIM2K",
      "transform": [
        {
          "type":"filter",
          "expr":"datum.step === current_step"

        },
        {
          "type":"formula",
          "expr":"split(replace(replace(datum.vector, '[',''),']',''),',')",
          "as":"vector"
        },
        {
          "type":"formula",
          "expr":"[toNumber(datum.vector[0]),toNumber(datum.vector[1]),toNumber(datum.vector[2]),toNumber(datum.vector[3])]",
          "as":"vector"
        },
        {
          "type": "formula",
          "expr": "datum.vector[0]+datum.vector[1]",
          "as": "y"
        },
        {
          "type": "formula",
          "expr": "datum.vector[2]+datum.vector[3]",
          "as": "x"
        },
        {"type": "formula", "expr": "floor(datum.neuron/10)", "as": "y-grid"},
        {"type": "formula", "expr": "datum.neuron%10", "as": "x-grid"},
        {
          "type": "lookup",
          "from": "predictions",
          "key": "neuron",
          "values": ["class"],
          "fields": ["neuron"]
        }
      ]
    },
    {
      "name": "links",
      "source": "neurons",
      "transform": [
        {
          "type": "project",
          "fields": ["neuron", "x-grid", "y-grid"],
          "as": ["source", "x", "y"]
        },
        {
          "type": "formula",
          "expr": "[(min(5,datum.y+1))*10+datum.x%10, datum.y*10+(min(9,datum.x+1))%10]",
          "as": "target"
        },
        {"type": "flatten", "fields": ["target"]},
        {
          "type": "lookup",
          "from": "neurons",
          "key": "neuron",
          "fields": ["source"],
          "values": ["x", "y"],
          "as": ["s_x", "s_y"]
        },
        {
          "type": "lookup",
          "from": "neurons",
          "key": "neuron",
          "fields": ["target"],
          "values": ["x", "y"],
          "as": ["t_x", "t_y"]
        },
        {
          "type": "lookup",
          "from": "neurons",
          "key": "neuron",
          "fields": ["target"],
          "values": ["x-grid", "y-grid"],
          "as": ["t_x-grid", "t_y-grid"]
        }
      ]
    }
  ],
  "legends": [
    {
      "orient": "right",
      "fill": "color",
      "labelColor": "#fff",
      "encode": {
        "labels": {"update": {"text": {"signal": "scale('label',datum.value)"}}}
      }
    }
  ],
  "scales": [
    {
      "name": "xscale",
      "type": "linear",
      "domain": {"data": "neurons", "field": "x"},
      "range": "width"
    },
    {
      "name": "xscale-grid",
      "type": "linear",
      "domain": {"data": "neurons", "field": "x-grid"},
      "range": [{"signal": "width*0.05"}, {"signal": "width*0.95"}]
    },
    {
      "name": "yscale",
      "type": "linear",
      "domain": {"data": "neurons", "field": "y"},
      "range": "height",
      "zero": false
    },
    {
      "name": "yscale-grid",
      "type": "linear",
      "domain": {"data": "neurons", "field": "y-grid"},
      "range": [{"signal": "height*0.05"}, {"signal": "height*0.95"}],
      "reverse": false,
      "zero": false
    },
    {
      "name": "color",
      "type": "ordinal",
      "domain": {"data": "predictions", "field": "class", "sort": true},
      "range": ["#555", "red", "yellow", "blue"]
    },
    {
      "name": "label",
      "type": "ordinal",
      "domain": {"data": "labels", "field": "id"},
      "range": {"data": "labels", "field": "name"}
    },
    {
      "name": "id",
      "type": "ordinal",
      "domain": {"data": "labels", "field": "name"},
      "range": {"data": "labels", "field": "id"}
    }
  ],
  "axes": [
    {
      "orient": "left",
      "scale": "yscale",
      "title": {"signal": "showgrid ? 'Rows':'Sepal.Width + Sepal.Length'"},
      "titleColor": "#fff",
      "domain": false,
      "labels": false,
      "ticks": false
    },
    {
      "orient": "bottom",
      "scale": "xscale",
      "titleColor": "#fff",
      "title": {"signal": "showgrid ? 'Columns':'Petal.Width + Petal.Length'"},
      "domain": false,
      "labels": false,
      "ticks": false
    }
  ],
    "marks": [
    {
      "type": "text",
      "encode": {
        "enter": {
          "fontSize": {"value": 14},
          "fontWeight": {"value": "bold"},
          "xc": {"signal": "width/2"},
          "align": {"value": "center"},
          "fill": {"value": "#eee"}
        },
        "update": {
          "text": {
            "signal": "showgrid ? 'Neuron map':'K-Means step: ' + current_step"
          }
        }
      }
    },
    {
      "type": "symbol",
      "from": {"data": "iris"},
      "encode": {
        "enter":{
          "stroke":{"value":"#555"}
        },
        "update": {
          "opacity":{"signal":"showrealdata && !showgrid ? 0.5 : 0"},
          "fill": {"field": "class", "scale": "color"},
          "xc":{"signal":"datum.pl + datum.pw", "scale":"xscale"},
          "yc":{"signal":"datum.sl + datum.sw", "scale":"yscale"}
        }
      }
    },
    {
      "type": "rule",
      "from": {"data": "links"},
      "encode": {
        "update": {
          "stroke": {"value": "#bbb"},
          "strokeWidth": {"value": 0.5},
          "opacity":{"signal": "showlinks && showneurons ? 1 :0"},
          "x": [
            {"test": "showgrid", "field": "x", "scale": "xscale-grid"},
            {"field": "s_x", "scale": "xscale"}
          ],
          "y": [
            {"test": "showgrid", "field": "y", "scale": "yscale-grid"},
            {"field": "s_y", "scale": "yscale"}
          ],
          "x2": [
            {"test": "showgrid", "field": "t_x-grid", "scale": "xscale-grid"},
            {"field": "t_x", "scale": "xscale"}
          ],
          "y2": [
            {"test": "showgrid", "field": "t_y-grid", "scale": "yscale-grid"},
            {"field": "t_y", "scale": "yscale"}
          ]
        }
      }
    },
    {
      "type": "symbol",
      "from": {"data": "neurons"},
      "encode": {
        "enter":{
          "stroke":{"value":"#555"}
        },
        "update": {
          "opacity":{"signal": "showneurons ? 1 : 0"},
          "size": [{"test": "showgrid", "value": 300},{"value":150}],
          "fill": {"field": "class", "scale": "color"},
          "xc": [
            {"test": "showgrid", "field": "x-grid", "scale": "xscale-grid"},
            {"field": "x", "scale": "xscale"}
          ],
          "yc": [
            {"test": "showgrid", "field": "y-grid", "scale": "yscale-grid"},
            {"field": "y", "scale": "yscale"}
          ]
        }
      }
    }
  ]
};
  vegaEmbed('#vis', spec).then(function(result) {
  }).catch(console.error);

</script>
</body>
</html>
